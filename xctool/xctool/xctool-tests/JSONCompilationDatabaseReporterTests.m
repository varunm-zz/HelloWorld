#import <SenTestingKit/SenTestingKit.h>

#import "JSONCompilationDatabaseReporter.h"
#import "Options.h"
#import "Reporter+Testing.h"

@interface JSONCompilationDatabaseReporterTests : SenTestCase
@end

@implementation JSONCompilationDatabaseReporterTests

- (void)testBuild
{
  NSData *outputData = [JSONCompilationDatabaseReporter
                        outputDataWithEventsFromFile:TEST_DATA @"TestProject-Library-TestProject-LibraryTests-build.txt"
                                             options:nil];
  NSString *jsonStr = [[[NSString alloc] initWithData:outputData
                                            encoding:NSUTF8StringEncoding] autorelease];
  STAssertEqualObjects(@"\
[\n\
  {\n\
    \"command\" : \"\\/Applications\\/Xcode.app\\/Contents\\/Developer\\/Toolchains\\/XcodeDefault.xctoolchain\\/usr\\/bin\\/clang -x objective-c -arch armv7s -fmessage-length=0 -std=gnu99 -Wno-trigraphs -fpascal-strings -Os -Wno-missing-field-initializers -Wno-missing-prototypes -Wreturn-type -Wno-implicit-atomic-properties -Wno-receiver-is-weak -Wduplicate-method-match -Wformat -Wno-missing-braces -Wparentheses -Wswitch -Wno-unused-function -Wno-unused-label -Wno-unused-parameter -Wunused-variable -Wunused-value -Wempty-body -Wuninitialized -Wno-unknown-pragmas -Wno-shadow -Wno-four-char-constants -Wno-conversion -Wno-constant-conversion -Wno-int-conversion -Wno-enum-conversion -Wno-shorten-64-to-32 -Wpointer-sign -Wno-newline-eof -Wno-selector -Wno-strict-selector-match -Wno-undeclared-selector -Wno-deprecated-implementations -isysroot \\/Applications\\/Xcode.app\\/Contents\\/Developer\\/Platforms\\/iPhoneOS.platform\\/Developer\\/SDKs\\/iPhoneOS6.1.sdk -fstrict-aliasing -Wprotocol -Wdeprecated-declarations -g -Wno-sign-conversion -miphoneos-version-min=6.0 -iquote \\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/TestProject-Library-generated-files.hmap -I\\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/TestProject-Library-own-target-headers.hmap -I\\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/TestProject-Library-all-target-headers.hmap -iquote \\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/TestProject-Library-project-headers.hmap -I\\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Products\\/Release-iphoneos\\/include -I\\/Applications\\/Xcode.app\\/Contents\\/Developer\\/Toolchains\\/XcodeDefault.xctoolchain\\/usr\\/include -I\\/Applications\\/Xcode.app\\/Contents\\/Developer\\/Toolchains\\/XcodeDefault.xctoolchain\\/usr\\/include -I\\/Applications\\/Xcode.app\\/Contents\\/Developer\\/Toolchains\\/XcodeDefault.xctoolchain\\/usr\\/include -I\\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/DerivedSources\\/armv7s -I\\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/DerivedSources -F\\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Products\\/Release-iphoneos -include \\/Users\\/fpotter\\/fb\\/git\\/xctool\\/xctool\\/xctool-tests\\/TestData\\/TestProject-Library\\/TestProject-Library\\/TestProject-Library-Prefix.pch -MMD -MT dependencies -MF \\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/Objects-normal\\/armv7s\\/TestProject_Library.d --serialize-diagnostics \\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/Objects-normal\\/armv7s\\/TestProject_Library.dia -c \\/Users\\/fpotter\\/fb\\/git\\/xctool\\/xctool\\/xctool-tests\\/TestData\\/TestProject-Library\\/TestProject-Library\\/TestProject_Library.m -o \\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/Objects-normal\\/armv7s\\/TestProject_Library.o\",\n\
    \"directory\" : \"\\/Users\\/fpotter\\/fb\\/git\\/xctool\\/xctool\\/xctool-tests\\/TestData\\/TestProject-Library\",\n\
    \"file\" : \"\\/Users\\/fpotter\\/fb\\/git\\/xctool\\/xctool\\/xctool-tests\\/TestData\\/TestProject-Library\\/TestProject-Library\\/TestProject_Library.m\"\n\
  },\n\
  {\n\
    \"command\" : \"\\/Applications\\/Xcode.app\\/Contents\\/Developer\\/Toolchains\\/XcodeDefault.xctoolchain\\/usr\\/bin\\/clang -x objective-c -arch armv7 -fmessage-length=0 -std=gnu99 -Wno-trigraphs -fpascal-strings -Os -Wno-missing-field-initializers -Wno-missing-prototypes -Wreturn-type -Wno-implicit-atomic-properties -Wno-receiver-is-weak -Wduplicate-method-match -Wformat -Wno-missing-braces -Wparentheses -Wswitch -Wno-unused-function -Wno-unused-label -Wno-unused-parameter -Wunused-variable -Wunused-value -Wempty-body -Wuninitialized -Wno-unknown-pragmas -Wno-shadow -Wno-four-char-constants -Wno-conversion -Wno-constant-conversion -Wno-int-conversion -Wno-enum-conversion -Wno-shorten-64-to-32 -Wpointer-sign -Wno-newline-eof -Wno-selector -Wno-strict-selector-match -Wno-undeclared-selector -Wno-deprecated-implementations -isysroot \\/Applications\\/Xcode.app\\/Contents\\/Developer\\/Platforms\\/iPhoneOS.platform\\/Developer\\/SDKs\\/iPhoneOS6.1.sdk -fstrict-aliasing -Wprotocol -Wdeprecated-declarations -g -Wno-sign-conversion -miphoneos-version-min=6.0 -iquote \\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/TestProject-Library-generated-files.hmap -I\\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/TestProject-Library-own-target-headers.hmap -I\\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/TestProject-Library-all-target-headers.hmap -iquote \\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/TestProject-Library-project-headers.hmap -I\\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Products\\/Release-iphoneos\\/include -I\\/Applications\\/Xcode.app\\/Contents\\/Developer\\/Toolchains\\/XcodeDefault.xctoolchain\\/usr\\/include -I\\/Applications\\/Xcode.app\\/Contents\\/Developer\\/Toolchains\\/XcodeDefault.xctoolchain\\/usr\\/include -I\\/Applications\\/Xcode.app\\/Contents\\/Developer\\/Toolchains\\/XcodeDefault.xctoolchain\\/usr\\/include -I\\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/DerivedSources\\/armv7 -I\\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/DerivedSources -F\\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Products\\/Release-iphoneos -include \\/Users\\/fpotter\\/fb\\/git\\/xctool\\/xctool\\/xctool-tests\\/TestData\\/TestProject-Library\\/TestProject-Library\\/TestProject-Library-Prefix.pch -MMD -MT dependencies -MF \\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/Objects-normal\\/armv7\\/TestProject_Library.d --serialize-diagnostics \\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/Objects-normal\\/armv7\\/TestProject_Library.dia -c \\/Users\\/fpotter\\/fb\\/git\\/xctool\\/xctool\\/xctool-tests\\/TestData\\/TestProject-Library\\/TestProject-Library\\/TestProject_Library.m -o \\/Users\\/fpotter\\/Library\\/Developer\\/Xcode\\/DerivedData\\/TestProject-Library-fsljtldcjttttseqpqryyyihhqjz\\/Build\\/Intermediates\\/TestProject-Library.build\\/Release-iphoneos\\/TestProject-Library.build\\/Objects-normal\\/armv7\\/TestProject_Library.o\",\n\
    \"directory\" : \"\\/Users\\/fpotter\\/fb\\/git\\/xctool\\/xctool\\/xctool-tests\\/TestData\\/TestProject-Library\",\n\
    \"file\" : \"\\/Users\\/fpotter\\/fb\\/git\\/xctool\\/xctool\\/xctool-tests\\/TestData\\/TestProject-Library\\/TestProject-Library\\/TestProject_Library.m\"\n\
  }\n\
]\n", jsonStr, @"compile_commands.json should match");
}

- (void)testTestResults
{
  NSData *outputData = [JSONCompilationDatabaseReporter
                        outputDataWithEventsFromFile:TEST_DATA @"TestProject-Library-TestProject-LibraryTests-test-results.txt"
                                             options:nil];
  NSString *jsonStr = [[[NSString alloc] initWithData:outputData
                                            encoding:NSUTF8StringEncoding] autorelease];
  STAssertEqualObjects(@"\
[\n\
\n\
]\n", jsonStr, @"compile_commands.json should match");
}

@end
